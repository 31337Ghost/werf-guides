configVersion: 1
project: werfio-guides
---

{{- range $lang := list "en" "ru" }}
image: guides_{{ $lang }}
from: jekyll/builder:3
git:
  - add: /
    to: /guides
    owner: jekyll
    group: jekyll
    excludePaths:
      - .helm
      - .werf
      - .github
      - werf.yaml
      - examples
    stageDependencies:
      beforeSetup: ['Gemfile','Gemfile.lock']
      setup:
        - _config.yml
        - _config_{{ $lang }}.yml
        - pages_{{ $lang }}
        - werf.io
        - ru.werf.io
ansible:
  beforeSetup:
  - name: "Install Dependencies"
    shell: |
      export PATH=/usr/jekyll/bin/:$PATH
      bundle install
    args:
      executable: /bin/bash
      chdir: /guides
  setup:
  - name: "Build static files"
    shell: bundle exec jekyll build --config _config.yml,_config_{{ $lang }}.yml
    args:
      executable: /bin/bash
      chdir: /guides
---
{{ end -}}
image: frontend
from: nginx:stable-alpine
ansible:
  setup:
  - name: "Setup /etc/nginx/nginx.conf"
    copy:
      content: |
{{ .Files.Get ".werf/nginx.conf" | indent 8 }}
      dest: /etc/nginx/nginx.conf
import:
{{- range $lang := list "en" "ru" }}
- image: guides_{{ $lang }}
  add: /guides/_site
  to: /guides_{{ $lang }}
  before: setup
{{ end -}}
